<html>

<head>
    <title>Data transfer complete</title>
</head>
<style>
    body {
        font-family: "Open Sans", serif;
        background-color: rgb(56, 56, 56);
        text-align: center;
        color: white;
    }

    a {
        color: #1E90FF;
    }

    .contents {
        margin-left: 20%;
        margin-right: 20%;
    }

    .underline {
        text-decoration: underline;
    }

    .bold {
        font-weight: bold;
    }

    .left {
        text-align: left;
        text-indent: 2em;
        line-height: 1.7em;
        font-weight: bold;
        font-size: 16px;
    }
</style>

<body>
    <div class="contents">
        <br>
        <h1>Data Received</h1>
        <hr>
        <div class="left">
            <p>Your save data has been uploaded to the new website, if you keep playing and make more progress you'll
                need to do another transfer.</p>
            <p>Your future proof, enjoy :)</p>
            <a href="javascript:history.back()">Go back</a>
        </div>
    </div>

    <script>
        let receivedData = '';  // To hold the full data
        let expectedChunks = 0; // The total number of chunks to expect
        let currentIndex = 0;   // The current index we are expecting

        // Listen for incoming messages from oldsite.com
        window.addEventListener('message', (event) => {
            // Check the origin of the message to ensure it's from the expected source (oldsite.com)
                if (event.data.type === 'sendLocalStorageChunk') {
                    const { chunkIndex, chunk, totalChunks } = event.data;

                    // Ensure the chunks are received in order
                    if (chunkIndex === currentIndex) {
                        // Append the chunk to the full data
                        receivedData += chunk;
                        currentIndex++;

                        // Check if all chunks have been received
                        if (currentIndex === totalChunks) {
                            // Store the reassembled data in localStorage
                            localStorage.setItem("RetroBowl.0.savedata.ini", receivedData);
                            console.log('Data successfully reassembled and saved to localStorage.');

                            // Fire a custom event when the transfer is complete
                            window.dispatchEvent(new CustomEvent('localStorageTransferComplete', { detail: 'Reassembly complete!' }));
                        }
                    } else {
                        console.error(`Unexpected chunk index: ${chunkIndex}. Expected ${currentIndex}.`);
                    }

                    // Set the totalChunks if it's the first chunk
                    if (expectedChunks === 0) {
                        expectedChunks = totalChunks;
                    }
                }
        });

    </script>

</body>

</html>